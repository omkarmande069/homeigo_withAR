<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seller Dashboard - HomeGo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .active-tab { @apply border-amber-600 text-amber-600; }
    .inactive-tab { @apply border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300; }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Navigation -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-3">
          <a href="index.html" class="text-2xl font-bold text-amber-600">HomeGo</a>
          <span class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full">Seller</span>
        </div>
        <div class="flex items-center space-x-4">
          <span class="text-sm text-gray-700" id="seller-name">John's Store</span>
          <button onclick="logout()" class="text-sm text-red-600 hover:text-red-800">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 py-6">
    
    <!-- Tabs -->
    <div class="border-b border-gray-200 mb-6">
      <nav class="-mb-px flex space-x-8">
        <button onclick="switchTab('dashboard')" id="tab-dashboard" class="active-tab py-4 px-1 border-b-2 font-medium text-sm">
          Dashboard
        </button>
        <button onclick="switchTab('products')" id="tab-products" class="inactive-tab py-4 px-1 border-b-2 font-medium text-sm">
          Products
        </button>
        <button onclick="switchTab('sales')" id="tab-sales" class="inactive-tab py-4 px-1 border-b-2 font-medium text-sm">
          Sales Data
        </button>
        <button onclick="switchTab('support')" id="tab-support" class="inactive-tab py-4 px-1 border-b-2 font-medium text-sm">
          Support
        </button>
      </nav>
    </div>

    <!-- Dashboard Tab -->
    <div id="content-dashboard" class="tab-content">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-xl shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">Total Sales</p>
              <p class="text-2xl font-bold text-gray-900" id="total-sales">$0</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">Total Orders</p>
              <p class="text-2xl font-bold text-gray-900" id="total-orders">0</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">Products Listed</p>
              <p class="text-2xl font-bold text-gray-900" id="total-products">0</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-gray-600">Avg. Rating</p>
              <p class="text-2xl font-bold text-gray-900">4.8</p>
            </div>
            <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
              <svg class="w-6 h-6 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-lg font-semibold mb-4">Sales Overview</h3>
          <canvas id="salesChart"></canvas>
        </div>

        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-lg font-semibold mb-4">Recent Orders</h3>
          <div id="recent-orders" class="space-y-3"></div>
        </div>
      </div>
    </div>

    <!-- Products Tab -->
    <div id="content-products" class="tab-content hidden">
      <div class="bg-white rounded-xl shadow p-6 mb-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold">My Products</h2>
          <button onclick="openAddProductModal()" class="bg-amber-600 text-white px-6 py-2 rounded-lg hover:bg-amber-700 transition">
            + Add Product
          </button>
        </div>
        
        <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>
    </div>

    <!-- Sales Data Tab -->
    <div id="content-sales" class="tab-content hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-sm font-medium text-gray-600 mb-2">This Month</h3>
          <p class="text-3xl font-bold text-gray-900" id="month-sales">$0</p>
          <p class="text-sm text-green-600 mt-2">↑ 12.5% from last month</p>
        </div>
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-sm font-medium text-gray-600 mb-2">This Week</h3>
          <p class="text-3xl font-bold text-gray-900" id="week-sales">$0</p>
          <p class="text-sm text-green-600 mt-2">↑ 8.2% from last week</p>
        </div>
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-sm font-medium text-gray-600 mb-2">Today</h3>
          <p class="text-3xl font-bold text-gray-900" id="today-sales">$0</p>
          <p class="text-sm text-green-600 mt-2">5 orders</p>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-6 mb-6">
        <h3 class="text-lg font-semibold mb-4">Sales Analytics</h3>
        <canvas id="detailedSalesChart"></canvas>
      </div>

      <div class="bg-white rounded-xl shadow p-6">
        <h3 class="text-lg font-semibold mb-4">Top Selling Products</h3>
        <div id="top-products" class="space-y-4"></div>
      </div>
    </div>

    <!-- Support Tab -->
    <div id="content-support" class="tab-content hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-sm font-medium text-gray-600 mb-2">Open Tickets</h3>
          <p class="text-3xl font-bold text-gray-900" id="open-tickets">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-sm font-medium text-gray-600 mb-2">In Progress</h3>
          <p class="text-3xl font-bold text-gray-900" id="progress-tickets">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-6">
          <h3 class="text-sm font-medium text-gray-600 mb-2">Resolved</h3>
          <p class="text-3xl font-bold text-gray-900" id="resolved-tickets">0</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1">
          <div class="bg-white rounded-xl shadow p-6">
            <h3 class="text-lg font-semibold mb-4">Create Support Ticket</h3>
            <form id="support-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
                <input type="text" id="ticket-subject" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                <select id="ticket-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                  <option value="general">General Inquiry</option>
                  <option value="payment">Payment Issue</option>
                  <option value="technical">Technical Support</option>
                  <option value="account">Account Issue</option>
                  <option value="product">Product Related</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                <select id="ticket-priority" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                <textarea id="ticket-message" rows="4" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"></textarea>
              </div>
              <button type="submit" class="w-full bg-amber-600 text-white py-3 rounded-lg hover:bg-amber-700 transition">
                Submit Ticket
              </button>
            </form>
          </div>
        </div>

        <div class="lg:col-span-2">
          <div class="bg-white rounded-xl shadow p-6">
            <h3 class="text-lg font-semibold mb-4">My Tickets</h3>
            <div id="seller-tickets" class="space-y-4"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Add Product Modal -->
  <div id="add-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Add New Product</h2>
        <button onclick="closeAddProductModal()" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <form id="add-product-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
          <input type="text" id="product-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
          <select id="product-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
            <option value="furniture">Furniture</option>
            <option value="decor">Decor</option>
            <option value="lighting">Lighting</option>
            <option value="kitchen">Kitchen</option>
            <option value="bedroom">Bedroom</option>
            <option value="outdoor">Outdoor</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Price ($)</label>
            <input type="number" id="product-price" step="0.01" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Stock</label>
            <input type="number" id="product-stock" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
          <input type="url" id="product-image" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
          <textarea id="product-description" rows="3" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500"></textarea>
        </div>
        <button type="submit" class="w-full bg-amber-600 text-white py-3 rounded-lg hover:bg-amber-700 transition">
          Add Product
        </button>
      </form>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="currency.js"></script>
  <script src="api.js"></script>
  <script src="chatbot.js"></script>

  <script>
    const currencyManager = new CurrencyManager();
    let sellerProducts = [];
    let sellerOrders = [];
    
    // Get seller info from session
    const session = JSON.parse(localStorage.getItem('userSession') || '{}');
    const sellerId = session.userId || 'seller1';
    const sellerEmail = session.email || 'seller@example.com';

    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.classList.remove('active-tab');
        el.classList.add('inactive-tab');
      });
      document.getElementById(`content-${tab}`).classList.remove('hidden');
      document.getElementById(`tab-${tab}`).classList.remove('inactive-tab');
      document.getElementById(`tab-${tab}`).classList.add('active-tab');
      
      if (tab === 'dashboard') loadDashboard();
      if (tab === 'products') loadProducts();
      if (tab === 'sales') loadSalesData();
      if (tab === 'support') loadSupport();
    }

    async function loadDashboard() {
      try {
        // Fetch data from API
        const [products, orders, stats] = await Promise.all([
          API.getProducts({ sellerId }),
          API.getOrders({ sellerId }),
          API.getSellerStats(sellerId)
        ]);
        
        sellerProducts = products;
        sellerOrders = orders;
        
        document.getElementById('total-sales').textContent = currencyManager.format(stats.totalSales || 0);
        document.getElementById('total-orders').textContent = stats.totalOrders || 0;
        document.getElementById('total-products').textContent = stats.totalProducts || 0;

      // Recent orders
      const recentOrders = sellerOrders.slice(0, 5);
      document.getElementById('recent-orders').innerHTML = recentOrders.length === 0 
        ? '<p class="text-gray-500 text-sm">No orders yet</p>'
        : recentOrders.map(order => `
          <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
            <div>
              <p class="font-medium text-sm">${order.id}</p>
              <p class="text-xs text-gray-600">${new Date(order.date).toLocaleDateString()}</p>
            </div>
            <p class="font-semibold">${currencyManager.format(order.total)}</p>
          </div>
        `).join('');

        // Sales chart
        const ctx = document.getElementById('salesChart');
        if (ctx) {
          new Chart(ctx, {
            type: 'line',
            data: {
              labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
              datasets: [{
                label: 'Sales',
                data: [1200, 1900, 1500, 2500, 2200, 3000, 2800],
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4
              }]
            },
            options: { responsive: true, maintainAspectRatio: true }
          });
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
        alert('Failed to load dashboard data');
      }
    }

    function loadProducts() {
      const container = document.getElementById('products-list');
      container.innerHTML = sellerProducts.length === 0 
        ? '<div class="col-span-full text-center py-12"><p class="text-gray-500">No products yet. Add your first product!</p></div>'
        : sellerProducts.map(product => `
          <div class="bg-white border rounded-xl overflow-hidden hover:shadow-lg transition">
            <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover">
            <div class="p-4">
              <h3 class="font-semibold text-gray-900 mb-2">${product.name}</h3>
              <p class="text-sm text-gray-600 mb-3 line-clamp-2">${product.description}</p>
              <div class="flex justify-between items-center mb-3">
                <span class="text-lg font-bold text-amber-600">${currencyManager.format(product.price)}</span>
                <span class="text-sm text-gray-600">Stock: ${product.stock}</span>
              </div>
              <button onclick="removeProduct('${product.id}')" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition text-sm">
                Remove Product
              </button>
            </div>
          </div>
        `).join('');
    }

    function loadSalesData() {
      const totalSales = sellerOrders.reduce((sum, order) => sum + order.total, 0);
      document.getElementById('month-sales').textContent = currencyManager.format(totalSales);
      document.getElementById('week-sales').textContent = currencyManager.format(totalSales * 0.3);
      document.getElementById('today-sales').textContent = currencyManager.format(totalSales * 0.05);

      // Detailed sales chart
      const ctx = document.getElementById('detailedSalesChart');
      if (ctx) {
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
              label: 'Monthly Sales',
              data: [3200, 4100, 3800, 5200, 4800, 6100, 5500, 7200, 6800, 8100, 7500, 9200],
              backgroundColor: '#f59e0b'
            }]
          },
          options: { responsive: true, maintainAspectRatio: true }
        });
      }

      // Top products
      document.getElementById('top-products').innerHTML = sellerProducts.slice(0, 5).map((product, idx) => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <div class="flex items-center space-x-3">
            <span class="font-bold text-lg text-gray-400">${idx + 1}</span>
            <img src="${product.image}" alt="${product.name}" class="w-12 h-12 object-cover rounded">
            <div>
              <p class="font-medium">${product.name}</p>
              <p class="text-sm text-gray-600">${Math.floor(Math.random() * 50 + 10)} sold</p>
            </div>
          </div>
          <p class="font-semibold">${currencyManager.format(product.price * (Math.floor(Math.random() * 50 + 10)))}</p>
        </div>
      `).join('');
    }

    async function loadSupport() {
      try {
        const tickets = await API.getSupportTickets({ userEmail: sellerEmail });
        const allTickets = await API.getSupportTickets();
      
        document.getElementById('open-tickets').textContent = tickets.filter(t => t.status === 'open').length;
        document.getElementById('progress-tickets').textContent = tickets.filter(t => t.status === 'in-progress').length;
        document.getElementById('resolved-tickets').textContent = tickets.filter(t => t.status === 'resolved').length;

        document.getElementById('seller-tickets').innerHTML = tickets.length === 0
          ? '<p class="text-gray-500 text-sm">No tickets yet</p>'
          : tickets.map(ticket => `
          <div class="border rounded-lg p-4">
            <div class="flex justify-between items-start mb-2">
              <div>
                <p class="font-semibold">${ticket.subject}</p>
                <p class="text-xs text-gray-600">${ticket.id}</p>
              </div>
              <span class="px-3 py-1 text-xs font-semibold rounded-full ${
                ticket.status === 'open' ? 'bg-yellow-100 text-yellow-800' :
                ticket.status === 'in-progress' ? 'bg-blue-100 text-blue-800' :
                ticket.status === 'resolved' ? 'bg-green-100 text-green-800' :
                'bg-gray-100 text-gray-800'
              }">${ticket.status}</span>
            </div>
            <p class="text-sm text-gray-700 mb-3">${ticket.message}</p>
            <div class="flex justify-between items-center text-xs text-gray-500">
              <span>${new Date(ticket.createdAt).toLocaleString()}</span>
              <span class="px-2 py-1 bg-gray-100 rounded">${ticket.priority}</span>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading support:', error);
      }
    }

    // Product Management
    function openAddProductModal() {
      document.getElementById('add-product-modal').classList.remove('hidden');
    }

    function closeAddProductModal() {
      document.getElementById('add-product-modal').classList.add('hidden');
      document.getElementById('add-product-form').reset();
    }

    document.getElementById('add-product-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const product = {
        name: document.getElementById('product-name').value,
        category: document.getElementById('product-category').value,
        price: parseFloat(document.getElementById('product-price').value),
        stock: parseInt(document.getElementById('product-stock').value),
        image: document.getElementById('product-image').value,
        description: document.getElementById('product-description').value,
        sellerId: sellerId
      };
      
      try {
        await API.createProduct(product);
        closeAddProductModal();
        loadProducts();
        alert('Product added successfully!');
      } catch (error) {
        console.error('Error adding product:', error);
        alert('Failed to add product');
      }
    });

    async function removeProduct(id) {
      if (confirm('Are you sure you want to remove this product?')) {
        try {
          await API.deleteProduct(id);
          loadProducts();
        } catch (error) {
          console.error('Error removing product:', error);
          alert('Failed to remove product');
        }
      }
    }

    // Support Ticket
    document.getElementById('support-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      try {
        const ticket = await API.createSupportTicket({
          subject: document.getElementById('ticket-subject').value,
          message: document.getElementById('ticket-message').value,
          category: document.getElementById('ticket-category').value,
          priority: document.getElementById('ticket-priority').value,
          userType: 'seller',
          userName: session.name || "Seller",
          userEmail: sellerEmail
        });
        alert('Support ticket created: ' + ticket.ticketId);
        this.reset();
        loadSupport();
      } catch (error) {
        console.error('Error creating ticket:', error);
        alert('Failed to create ticket');
      }
    });

    function logout() {
      window.location.href = 'index.html';
    }

    // Initialize
    loadDashboard();

    // Initialize AI Chatbot for Sellers
    const GEMINI_API_KEY = 'AIzaSyD3EZAjIV5vNvJR2Gdo41lqrQ8Jy9dwfYM';
    try {
      window.homeGoChatbot = new HomeGoChatbot(GEMINI_API_KEY, {
        allowedRoles: ['seller']
      });
      console.log('✅ Chatbot initialized for seller');
    } catch (error) {
      console.error('❌ Chatbot error:', error);
    }
  </script>
</body>
</html>
